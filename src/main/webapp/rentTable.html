<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="shortcut icon" href="img/logo.png">
	
	<title>Afw Rental Page</title>
	
	      <!-- Bootstrap core CSS -->
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/bootstrap-reset.css" rel="stylesheet">
	
	<!--Animation css-->
	<link href="css/animate.css" rel="stylesheet">
	
	<!-- sweet alerts -->
	<link href="assets/sweet-alert/sweet-alert.min.css" rel="stylesheet">
	
	<!--Icon-fonts css-->
	<link href="assets/font-awesome/css/font-awesome.css" rel="stylesheet" />
	<link href="assets/ionicon/css/ionicons.min.css" rel="stylesheet" />
	
	<!-- DataTables -->
	<link rel="stylesheet" href="assets/magnific-popup/magnific-popup.css" />
	<link rel="stylesheet" href="assets/jquery-datatables-editable/datatables.css" />
	
	<!-- Custom styles for this template -->
	<link href="css/style.css" rel="stylesheet">
	<link href="css/helper.css" rel="stylesheet">
	
	<!-- Responsive-table -->
    <link href="assets/responsive-table/rwd-table.min.css" rel="stylesheet" type="text/css" media="screen"/>
	
	
	<!-- HTML5 shim and Respond.js IE8 support of HTML5 tooltipss and media queries -->
	<!--[if lt IE 9]>
	  <script src="js/html5shiv.js"></script>
	  <script src="js/respond.min.js"></script>
	<![endif]-->
<style>
.company_link:hover {
    text-decoration: underline;
}
.label {
	font-size:100%;
}
</style>
</head>
<body>
	<!-- Aside Start-->
 	<aside class="left-panel">

	    <!-- brand -->
	    <div class="logo">
	        <a href="index.html" class="logo-expanded">
<!-- 	            <img src="img/logo.png" alt="logo"> -->
				<i class="ion-social-buffer"></i>
				<span class="nav-label">AFW_SYSTEM</span>
	        </a>
	    </div>
	    <!-- / brand -->
	
	    <!-- Navbar Start -->
	    <nav class="navigation">
	        <ul class="list-unstyled">
<!-- 	            <li><a href="index.html"><i class="ion-home"></i> <span class="nav-label">Dashboard</span></a></li> -->
<!-- 	            <li class="has-submenu"><a href="#"><i class="ion-flask"></i> <span class="nav-label">UI Elements</span></a> -->
<!-- 	                <ul class="list-unstyled"> -->
<!-- 	                    <li><a href="typography.html">Typography</a></li> -->
<!-- 	                    <li><a href="buttons.html">Buttons</a></li> -->
<!-- 	                    <li><a href="icons.html">Icons</a></li> -->
<!-- 	                    <li><a href="panels.html">Panels</a></li> -->
<!-- 	                    <li><a href="tabs-accordions.html">Tabs &amp; Accordions</a></li> -->
<!-- 	                    <li><a href="modals.html">Modals</a></li> -->
<!-- 	                    <li><a href="bootstrap-ui.html">BS Elements</a></li> -->
<!-- 	                    <li><a href="progressbars.html">Progress Bars</a></li> -->
<!-- 	                    <li><a href="notification.html">Notification</a></li> -->
<!-- 	                    <li><a href="sweet-alert.html">Sweet-Alert</a></li> -->
<!-- 	                </ul> -->
<!-- 	            </li> -->
<!-- 	            <li class="has-submenu"><a href="#"><i class="ion-settings"></i> <span class="nav-label">Components</span><span class="badge bg-success">New</span></a> -->
<!-- 	                <ul class="list-unstyled"> -->
<!-- 	                    <li><a href="grid.html">Grid</a></li> -->
<!-- 	                    <li><a href="portlets.html">Portlets</a></li> -->
<!-- 	                    <li><a href="widgets.html">Widgets</a></li> -->
<!-- 	                    <li><a href="nestable-list.html">Nesteble</a></li> -->
<!-- 	                    <li><a href="calendar.html">Calendar</a></li> -->
<!-- 	                    <li><a href="ui-sliders.html">Range Slider</a></li> -->
<!-- 	                </ul> -->
<!-- 	            </li> -->
	            <li class="has-submenu"><a href="#"><i class="ion-compose"></i> <span class="nav-label">客戶資料</span></a>
	                <ul class="list-unstyled">
	                    <li><a href="addCompany.html">新增客戶合約</a></li>
	                    <li><a href="company.html">全部客戶</a></li>
	                    <li><a href="companyOffice.html">辦公室</a></li>
	                    <li><a href="companyPersonal.html">個人座位</a></li>
	                    <li><a href="companyRegister.html">登記</a></li>
	                    <li><a href="companyCC.html">聯絡處 & 停業</a></li>
	                    <li><a href="companyClose.html">退租</a></li>
	                </ul>
	            </li>
	            <li class="has-submenu active"><a href="#"><i class="ion-grid"></i> <span class="nav-label">收租</span></a>
	                <ul class="list-unstyled">
	                    <li><a href="searchRentTable.html">搜尋</a></li>
	                    <li class="active"><a href="rentTable.html">收租表</a></li>
	                </ul>
	            </li>
	        </ul>
	    </nav> 
	</aside>
	<!-- Aside Ends-->
	
	<!--Main Content Start -->
    <section class="content">
        <!-- Header -->
        <header class="top-head container-fluid">
        	<button type="button" class="navbar-toggle pull-left">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!-- user login dropdown start-->
            <ul class="nav navbar-nav navbar-right top-menu top-right-menu">
	            <li class="dropdown text-center">
	                <a data-toggle="dropdown" class="dropdown-toggle" href="#">
	                    <img alt="" src="img/logo.png" class="img-circle profile-img thumb-sm">
	                    <span class="username" id="userName">AFW</span> <span class="caret"></span>
	                </a>
	                <ul class="dropdown-menu pro-menu fadeInUp animated" tabindex="5003" style="overflow: hidden; outline: none;">
	                    <li><a href="#" id="logOut"><i class="fa fa-sign-out"></i> Log Out</a></li>
	                </ul>
	            </li>
            </ul>
        </header>
        <!-- Header Ends -->


        <!-- Page Content Start -->
        <!-- ================== -->

        <div class="wraper container-fluid">
			<div class="page-title"> 
                <h3 class="title"></h3> 
            </div>

			<!-- 根據不同權限看到不同分公司的客戶 table動態產生 thead也動態產生 目前先show admin的畫面-->
            <div class="panel">
                <div class="panel-body">
	                <div class="panel-heading">
	                    <h3 class="panel-title">收租表</h3>
	                </div>
	                <div>
	                	<div class="col-md-4">
							<div class="form-group">
								<label for="sel1">類型</label>
								<select class="form-control" id="contractType">
								    <option value="-1">請選擇</option>
                              		<option value="o">辦公室</option>
                              		<option value="p">個人座位</option>
                              		<option value="r">登記</option>
                              		<option value="c">聯絡處</option>
                              		<option value="s">停業</option>
                              		<option value="other">其他</option>
								</select>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label for="sel1">年份</label>
								<select class="form-control" id="year">
									<option value="-1">請選擇</option>
								    <option value="2015">2015</option>
								    <option value="2016">2016</option>
								    <option value="2017">2017</option>
								</select>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label for="sel1">公司名稱</label>
								<input class="form-control" disabled>
							</div>
						</div>
						<div class="col-md-2">
							<div class="form-group">
								<label for="sel1"></label>
								<button class="btn btn-primary pull-right" id="searchRent">搜尋</button>
							</div>
						</div>
						
	                </div>
                        <div class="row">
                    		<div class="col-lg-12">
                        		<div class="panel panel-default">
                            		<div class="panel-body table-rep-plugin"> 
                                		<div class="table-responsive" data-pattern="priority-columns">
                                    		<table id="tech-companies-1" class="table table-small-font table-bordered table-striped">
					                            <thead>
					                                <tr>
					                                	<th rowspan="2" style="vertical-align:middle">NO.</th>
					                                	<th>公司名稱</th>
					                                    <th>起租</th>
					                                    <th>押金</th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>1</div></th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>2</div></th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>3</div></th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>4</div></th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>5</div></th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>6</div></th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>7</div></th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>8</div></th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>9</div></th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>10</div></th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>11</div></th>
					                                    <th rowspan="2" style="vertical-align:middle"><div>12</div></th>
					                                </tr>
					                                <tr>
					                                	<th>統一編號</th>
					                                    <th>退租</th>
					                                    <th>租金</th>
					                                </tr>
					                            </thead>
					                            <tbody id="rentTbody"></tbody>
					                        </table>
                  						</div>
									</div>
        						</div>
        					</div>
        				</div>
        			</div>
        		</div>
        
        </div>
        <!-- Page Content Ends -->
        <!-- ================== -->
        
        <div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
			<div class="modal-dialog"> 
				<div class="modal-content"> 
	                <div class="modal-header"> 
	                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button> 
	                    <h4 class="modal-title">Rent</h4> 
	                </div> 
                    <div class="modal-body"> 
						<div class="row">
                           <div class="col-md-4"> 
								<div class="form-group"> 
                                  	<label for="rentDate" class="control-label">日期</label>
             						<input class=" form-control" id="rentDate" name="rentDate" type="text" value=""> 
                               	</div> 
                           </div>
                           <div class="col-md-4"> 
                               	<div class="form-group"> 
                                  	<label for="rentReceipt" class="control-label">發票號碼</label>
             						<input class=" form-control" id="rentReceipt" name="rentReceipt" type="text" value=""> 
                               	</div> 
                           </div>
                           <div class="col-md-4"> 
                               	<div class="form-group"> 
                                  	<label for="rentShortage" class="control-label">租金缺繳</label>
             						<input class=" form-control" id="rentShortage" name="rentShortage" type="text" value=""> 
                               	</div> 
                           </div>
                           <div class="col-md-12"> 
                               	<div class="form-group"> 
                                  	<label for="rentRemark" class="control-label">備註</label>
             						<input class=" form-control" id="rentRemark" name="rentRemark" type="text" value=""> 
                               	</div> 
                           </div>
                        </div>
                    </div> 
		            <div class="modal-footer"> 
		                <button type="button" class="btn btn-info" id="rentSave">Save</button>
		                <button type="button" class="btn btn-white" data-dismiss="modal" id="rentClose">Close</button>
		            </div> 
				</div> 
			</div>
		</div><!-- /.modal -->

        <!-- Footer Start -->
        <footer class="footer">
            2016 © AFW.
        </footer>
        <!-- Footer Ends -->


    </section>
    <!-- Main Content Ends -->
    
    <!-- MODAL -->
	<div id="dialog" class="modal-block mfp-hide">
	    <section class="panel panel-info panel-color">
	        <header class="panel-heading">
	            <h2 class="panel-title">Are you sure?</h2>
	        </header>
	        <div class="panel-body">
	            <div class="modal-wrapper">
	                <div class="modal-text">
	                    <p>Are you sure that you want to delete this row?</p>
	                </div>
	            </div>
	
	            <div class="row m-t-20">
	                <div class="col-md-12 text-right">
	                    <button id="dialogConfirm" class="btn btn-primary">Confirm</button>
	                    <button id="dialogCancel" class="btn btn-default">Cancel</button>
	                </div>
	            </div>
	        </div>
	    </section>
	</div>




<!-- js placed at the end of the document so the pages load faster -->
<script src="js/jquery.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/pace.min.js"></script>
<script src="js/modernizr.min.js"></script>
<script src="js/wow.min.js"></script>
<script src="js/jquery.scrollTo.min.js"></script>
<script src="js/jquery.nicescroll.js" type="text/javascript"></script>
<script src="js/jquery.app.js"></script>

<script src="assets/magnific-popup/magnific-popup.js"></script>
<script src="assets/jquery-datatables-editable/jquery.dataTables.js"></script> 
<script src="assets/datatables/dataTables.bootstrap.js"></script>
<script src="assets/jquery-datatables-editable/datatables.editable.init.js"></script>
<script src="assets/timepicker/bootstrap-datepicker.js"></script>
<!-- responsive-table--> 
<script src="assets/responsive-table/rwd-table.min.js" type="text/javascript"></script>

<script src="assets/sweet-alert/sweet-alert.min.js"></script>
<script src="assets/sweet-alert/sweet-alert.init.js"></script>

<script>
(function($){
	var companyId = 0;
	var contractId = 0;
	var month = 0;
	var type;
	var year;
	var dataArr;
	var root = location.protocol + '//' + location.host;
	
	$("#rentDate").datepicker({
       	format: 'yyyy-mm-dd',
       	autoclose: true
   	});
	
	window.clickInfoButton = function(e) {
		var id = e.target.id;
		var ids = id.split("_");
		companyId = ids[0];
		contractId = ids[1];
		month = ids[2];
		
		$('#rentDate').val('');
 		$('#rentReceipt').val('');
 		$('#rentShortage').val('');
 		$('#rentRemark').val('');
		
		for(var i =0; i<dataArr.length; i++) {
			var contractId2 = dataArr[i].contractId;
			if(contractId == contractId2) {
				var rentArr = dataArr[i].rentArr;
				for(var j =0; j<rentArr.length; j++) {
					var date = new Date(rentArr[j].rentDate);
		        	var day = ("0" + date.getDate()).slice(-2);
		        	var month2 = ("0" + (date.getMonth() + 1)).slice(-2);
		        	var dateFormat = date.getFullYear()+"-"+month2+"-"+day;
		        	
		        	var shortAge = rentArr[j].rentShortage;
		        	var remark = rentArr[j].rentRemark;
		        	var rentReceipt = rentArr[j].rentReceipt;
		        	
		        	if(date.getMonth() + 1 == month) {
						//$('#rentDate').html(dateFormat);
						$('#rentDate').val(dateFormat);
		         		$('#rentReceipt').val(rentReceipt);
		         		$('#rentShortage').val(shortAge);
		         		$('#rentRemark').val(remark);
		        	}
				}
			}
		}
		
	    $('#myModal').modal('show');
	}
	
	$('#rentSave').on('click', function() {
		if(contractId == 0 || month == 0) {
			alert("請重新操作");
		} else {
			createOrUpdateRent(contractId, month);
		}
	})
	
	var createOrUpdateRent = function(contractId, month) {
		var companyId = "";
		var rent = {
			rentYear : $('#year').val(),
			rentMonth : month,
			rentDate : $('#rentDate').val(),
			rentReceipt : $('#rentReceipt').val(),
			rentShortage : $('#rentShortage').val(),
			rentRemark : $('#rentRemark').val(),
		}
		
		console.log(JSON.stringify(rent));
		$.ajax({
			url:root + "/AFW-I-System/rent/merge/" + contractId,
			type:'post',
			data : JSON.stringify(rent),
			dataType : 'json',
			contentType: 'application/json; charset=UTF-8',
			success : function(data) {
				console.log(data);
				if(data.status == 'success') {
					$('#rentClose').click();
					swal("修改成功!", "", "success");
					retriveDataByTypeAndYear(type, year);
					
				} else {
					alert(data.message);
				}
			},
			error : function(e) {
				alert("something error");
				console.log("ERROR: ", e);
			},
			done : function(e) {
				console.log("DONE");
			}
		});
	}
	
	var retriveDataByTypeAndYear = function(type, year) {
		$.ajax({
			url:root + "/AFW-I-System/retrive/rent/" + type +"/"+year,
			type:'get',
			dataType : 'json',
			contentType: 'application/json; charset=UTF-8',
			success : function(data) {
				console.log(jQuery.parseJSON(data.message));
				//console.log(data.message);
				if(data.status == 'success') {
					dataArr = jQuery.parseJSON(data.message);
					setData(dataArr);
					
				} else {
					alert(data.message);
				}
			},
			error : function(e) {
				alert("something error");
				console.log("ERROR: ", e);
			},
			done : function(e) {
				console.log("DONE");
			}
		});
	}
	
	var setData = function(dataArr) {
		var str = "";
		for(var i=0; i<dataArr.length; i++) {
			var companyId = dataArr[i].companyId;
			var contractId = dataArr[i].contractId;
			var name = dataArr[i].companyName;
			var ein = dataArr[i].ein;
			var rent = dataArr[i].rent;
			var deposit = dataArr[i].deposit;
			
			var dateS = new Date(dataArr[i].start);
        	var day = ("0" + dateS.getDate()).slice(-2);
        	var month = ("0" + (dateS.getMonth() + 1)).slice(-2);
        	var dateFormatS = dateS.getFullYear()+"-"+month+"-"+day;
			var start = dateFormatS;
			
			var dateE = new Date(dataArr[i].end);
        	var day = ("0" + dateE.getDate()).slice(-2);
        	var month = ("0" + (dateE.getMonth() + 1)).slice(-2);
        	var dateFormatE = dateE.getFullYear()+"-"+month+"-"+day;
			var end = dateFormatE;
			
			var order = dataArr[i].officeNum;
			
			var str1 =  "<tr>" +
       					"<td rowspan=\"2\" style=\"vertical-align:middle\">"+ order + "</td>" +
       					"<td><a class=\"company_link\" href=\"companyProfile.html?id="+ companyId +"\">" + name + "</a></td>" +
       					"<td>"+ start + "</td>" +
       					"<td>"+ deposit + "</td>";
       		
       		var str2 = "</tr>" +
						"<tr>" +
       					"<td style=\"vertical-align:middle; border-bottom:2pt solid black\">"+ ein + "</td>" +
       					"<td style=\"border-bottom:2pt solid black\">"+ end + "</td>" +
       					"<td style=\"border-bottom:2pt solid black\">"+ rent + "</td>";
			
			var rentStr = "";
			var rentStr2 = ""; 
			var rentArr = dataArr[i].rentArr;
			
			for(var k=1; k<13; k++) {
				var exist = false;
				for(var j = 0; j<rentArr.length; j++) {
					var date = new Date(rentArr[j].rentDate);
		        	var day = ("0" + date.getDate()).slice(-2);
		        	var month = ("0" + (date.getMonth() + 1)).slice(-2);
		        	var dateFormat = date.getFullYear()+"-"+month+"-"+day;
		        	
		        	var shortAge = rentArr[j].rentShortage;
		        	var remark = rentArr[j].rentRemark;
		        	var rentReceipt = rentArr[j].rentReceipt;
		        	
		        	if(k == month) {
		        		exist = true;
		        		if(day == '01' && shortAge == 0) {
		        			rentStr = rentStr + "<td style=\"vertical-align:middle\"><span title=" + remark + " class=\"label" + " label-primary"+ " popupButton\" id=" + companyId+"_"+contractId+"_"+month + ">"+ day +"</span></td>";
			        	} else  if(day == '01' && shortAge != 0) {
			        		rentStr = rentStr + "<td style=\"vertical-align:middle\"><span title=" + remark + " onclick=\"clickInfoButton(event);\" class=\"label" + " label-danger"+ " popupButton\" id=" + companyId+"_"+contractId+"_"+month + ">"+ day +"</span></td>";
			        	} else if(day != '01' && shortAge == 0) {
			        		rentStr = rentStr + "<td style=\"vertical-align:middle\"><span title=" + remark + " class=\"label" + " label-primary"+ " popupButton\" id=" + companyId+"_"+contractId+"_"+month + ">"+ month + "-" + day +"</span></td>";
			        	} else {
			        		rentStr = rentStr + "<td style=\"vertical-align:middle\"><span title=" + remark + " onclick=\"clickInfoButton(event);\" class=\"label" + " label-danger"+ " popupButton\" id=" + companyId+"_"+contractId+"_"+month + ">"+ month + "-" + day +"</span></td>";
			        	}
		        		
		        		rentStr2 = rentStr2 +　"<td style=\"vertical-align:middle; border-bottom:2pt solid black\"><span class=\"label " + "label-info"+ " popupButton\" id=" + companyId+"_1" + ">" + rentReceipt + " </span></td>";
		        	}
				}
				if(!exist) {
					rentStr = rentStr + "<td style=\"vertical-align:middle\"><span onclick=\"clickInfoButton(event);\" class=\"label" + " label-success"+ " popupButton\" id=" + companyId+"_"+contractId+"_"+k + ">Save</span></td>";
					rentStr2 = rentStr2 + "<td style=\"vertical-align:middle; border-bottom:2pt solid black\"></td>"
				}
			}
			
			str = str + str1 + rentStr + str2 + rentStr2;
		}
		
		$('#rentTbody').html(str);
		
	}
	
	$('#logOut').on('click', function() {
    	logOut();
    })
    
    var logOut = function() {
    	$.ajax({
			url:root + "/AFW-I-System/new/user/logout",
			type:'get',
			dataType : 'json',
			contentType: 'application/json',
			success : function(response) {
				//alert("success");
				if(response.status == 'success') {
					window.location.href = root + "/AFW-I-System/login.html";
				}
			},
			error : function(e) {
				alert("error");
				console.log("ERROR: ", e);
			},
			done : function(e) {
				console.log("DONE");
			}
		});
    }
	
	$('#searchRent').on('click', function() {
		type = $('#contractType').val();
		year = $('#year').val();
		if(type != -1 && year != -1) {
			retriveDataByTypeAndYear(type, year);
		} else {
			alert('請選擇公司類型及年份');
		}
		
	});
	
	
	//page load
    window.onload = function() {
	};
})(jQuery);
</script>
</body>
</html>