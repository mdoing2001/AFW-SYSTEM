<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="shortcut icon" href="img/logo.png">
	
	<title>Afw Rental List Page</title>
	
	      <!-- Bootstrap core CSS -->
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/bootstrap-reset.css" rel="stylesheet">
	
	<!--Animation css-->
	<link href="css/animate.css" rel="stylesheet">
	
	<!-- sweet alerts -->
	<link href="assets/sweet-alert/sweet-alert.min.css" rel="stylesheet">
	
	<!--Icon-fonts css-->
	<link href="assets/font-awesome/css/font-awesome.css" rel="stylesheet" />
	<link href="assets/ionicon/css/ionicons.min.css" rel="stylesheet" />
	
	<!-- DataTables -->
	<link rel="stylesheet" href="assets/magnific-popup/magnific-popup.css" />
	<link rel="stylesheet" href="assets/jquery-datatables-editable/datatables.css" />
	
	<!-- Custom styles for this template -->
	<link href="css/style.css" rel="stylesheet">
	<link href="css/helper.css" rel="stylesheet">
	
	<!-- Responsive-table -->
    <link href="assets/responsive-table/rwd-table.min.css" rel="stylesheet" type="text/css" media="screen"/>
	
	<link href="css/common.css" rel="stylesheet">
	
	<!-- HTML5 shim and Respond.js IE8 support of HTML5 tooltipss and media queries -->
	<!--[if lt IE 9]>
	  <script src="js/html5shiv.js"></script>
	  <script src="js/respond.min.js"></script>
	<![endif]-->
<style>
.company_link:hover {
    text-decoration: underline;
}
.label {
	font-size:100%;
}
.form-control {
	color:black;
}
</style>
</head>
<body>
	<!-- Aside Start-->
 	<aside class="left-panel">

	    <!-- brand -->
	    <div class="logo">
	        <a href="index.html" class="logo-expanded">
<!-- 	            <img src="img/logo.png" alt="logo"> -->
				<i class="ion-social-buffer"></i>
				<span class="nav-label">AFW_SYSTEM</span>
	        </a>
	    </div>
	    <!-- / brand -->
	
	    <!-- Navbar Start -->
	    <nav class="navigation">
	        <ul class="list-unstyled">
	            <li class="has-submenu"><a href="#"><i class="ion-compose"></i> <span class="nav-label">客戶資料</span></a>
	                <ul class="list-unstyled">
	                    <li><a href="addCompany.html">新增客戶合約</a></li>
	                    <li><a href="company.html">全部客戶</a></li>
	                    <li><a href="companyOffice.html">辦公室</a></li>
	                    <li><a href="companyPersonal.html">個人座位</a></li>
	                    <li><a href="companyRegister.html">登記</a></li>
	                    <li><a href="companyCC.html">聯絡處 & 停業</a></li>
	                    <li><a href="companyClose.html">退租</a></li>
	                </ul>
	            </li>
	            <li class="has-submenu active"><a href="#"><i class="ion-grid"></i> <span class="nav-label">收租</span></a>
	                <ul class="list-unstyled">
	                    <li><a href="searchRentTable.html">搜尋</a></li>
	                    <li><a href="rentTable.html">收租表</a></li>
	                    <li class="active"><a href="rentListTable.html">收費清單</a></li>
	                </ul>
	            </li>
	            <li class="has-submenu" id="adminReconciliation" style="display:none">
	            	<a href="#"><i class="ion-stats-bars"></i> <span class="nav-label">對帳報表</span></a>
	                <ul class="list-unstyled">
	                    <li class="active"><a href="reconciliationTable.html">對帳</a></li>
	                    <li><a href="404.html">營收報表</a></li>
	                </ul>
	            </li>
	        </ul>
	    </nav> 
	</aside>
	<!-- Aside Ends-->
	
	<!--Main Content Start -->
    <section class="content">
        <!-- Header -->
        <header class="top-head container-fluid">
        	<button type="button" class="navbar-toggle pull-left">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!-- user login dropdown start-->
            <ul class="nav navbar-nav navbar-right top-menu top-right-menu">
	            <li class="dropdown text-center">
	                <a data-toggle="dropdown" class="dropdown-toggle" href="#">
	                    <img alt="" src="img/logo.png" class="img-circle profile-img thumb-sm">
	                    <span class="username" id="userName">AFW</span> <span class="caret"></span>
	                </a>
	                <ul class="dropdown-menu pro-menu fadeInUp animated" tabindex="5003" style="overflow: hidden; outline: none;">
	                    <li><a href="#" id="logOut"><i class="fa fa-sign-out"></i> Log Out</a></li>
	                </ul>
	            </li>
            </ul>
        </header>
        <!-- Header Ends -->


        <!-- Page Content Start -->
        <!-- ================== -->

        <div class="wraper container-fluid">
			<div class="page-title"> 
                <h3 class="title"></h3> 
            </div>

			<!-- 根據不同權限看到不同分公司的客戶 table動態產生 thead也動態產生 目前先show admin的畫面-->
            <div class="panel">
                <div class="panel-body">
	                <div class="panel-heading">
	                    <h3 class="panel-title">收費清單</h3>
	                </div>
	                <div>
	                	<div class="col-md-4">
							<div class="form-group">
								<label for="sel1">類型</label>
								<select class="form-control" id="contractType">
								    <option value="-1">請選擇</option>
                              		<option value="o">辦公室</option>
                              		<option value="p">個人座位</option>
								</select>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label for="sel1">年份</label>
								<select class="form-control" id="year">
									<option value="-1">請選擇</option>
								    <option value="2016">2016</option>
								    <option value="2017">2017</option>
								</select>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label for="sel1">公司名稱</label>
								<input class="form-control" disabled>
							</div>
						</div>
						<div class="col-md-2">
							<div class="form-group">
								<label for="sel1"></label>
								<button class="btn btn-primary pull-right" id="searchRent">搜尋</button>
							</div>
						</div>
						
	                </div>
                        <div class="row">
                    		<div class="col-lg-12">
                        		<div class="panel panel-default">
                            		<div class="panel-body table-rep-plugin"> 
                                		<div class="table-responsive" data-pattern="priority-columns">
                                    		<table id="tech-companies-1" class="table table-small-font table-bordered table-striped">
					                            <thead>
					                                <tr>
					                                	<th style="vertical-align:middle">NO.</th>
					                                	<th>公司名稱</th>
					                                    <th style="vertical-align:middle"><div>1</div></th>
					                                    <th style="vertical-align:middle"><div>2</div></th>
					                                    <th style="vertical-align:middle"><div>3</div></th>
					                                    <th style="vertical-align:middle"><div>4</div></th>
					                                    <th style="vertical-align:middle"><div>5</div></th>
					                                    <th style="vertical-align:middle"><div>6</div></th>
					                                    <th style="vertical-align:middle"><div>7</div></th>
					                                    <th style="vertical-align:middle"><div>8</div></th>
					                                    <th style="vertical-align:middle"><div>9</div></th>
					                                    <th style="vertical-align:middle"><div>10</div></th>
					                                    <th style="vertical-align:middle"><div>11</div></th>
					                                    <th style="vertical-align:middle"><div>12</div></th>
					                                </tr>
					                            </thead>
					                            <tbody id="rentTbody"></tbody>
					                        </table>
                  						</div>
									</div>
        						</div>
        					</div>
        				</div>
        			</div>
        		</div>
        
        </div>
        <!-- Page Content Ends -->
        <!-- ================== -->
        
        <div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
			<div class="modal-dialog"> 
				<div class="modal-content"> 
	                <div class="modal-header"> 
	                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button> 
	                    <h4 class="modal-title">Rent List</h4> 
	                </div> 
                    <div class="modal-body"> 
						<div class="row">
                           <div class="col-md-4"> 
								<div class="form-group"> 
                                  	<label for="rentDate" class="control-label">租金</label>
             						<input class=" form-control" id="rentPrice" name="rentPrice" type="text" value="" disabled> 
                               	</div> 
                           </div>
                           <div class="col-md-4"> 
                               	<div class="form-group"> 
                                  	<label for="rentReceipt" class="control-label">管理費</label>
             						<input class=" form-control" id="rentManager" name="rentManager" type="text" value=""> 
                               	</div> 
                           </div>
                           <div class="col-md-4"> 
                               	<div class="form-group"> 
                                  	<label for="rentShortage" class="control-label">電費</label>
             						<input class=" form-control" id="rentPower" name="rentPower" type="text" value=""> 
                               	</div> 
                           </div>
                           <div class="col-md-4"> 
								<div class="form-group"> 
                                  	<label for="rentDate" class="control-label">網路費</label>
             						<input class=" form-control" id="rentAdsl" name="rentAdsl" type="text" value=""> 
                               	</div> 
                           </div>
                           <div class="col-md-4"> 
                               	<div class="form-group"> 
                                  	<label for="rentReceipt" class="control-label">營業稅</label>
             						<input class=" form-control" id="rentBusiness" name="rentBusiness" type="text" value=""> 
                               	</div> 
                           </div>
                           <div class="col-md-4"> 
                               	<div class="form-group"> 
                                  	<label for="rentShortage" class="control-label">其他</label>
             						<input class=" form-control" id="rentOther" name="rentOther" type="text" value=""> 
                               	</div> 
                           </div>
                           <div class="col-md-12"> 
                               	<div class="form-group"> 
                                  	<label for="rentRemark" class="control-label">總和</label>
             						<input class=" form-control" id="rentTotal" name="rentTotal" type="text" value="" disabled> 
                               	</div> 
                           </div>
                        </div>
                    </div> 
		            <div class="modal-footer"> 
		                <button type="button" class="btn btn-info" id="rentSave">Save</button>
		                <button type="button" class="btn btn-white" data-dismiss="modal" id="rentClose">Close</button>
		            </div> 
				</div> 
			</div>
		</div><!-- /.modal -->

        <!-- Footer Start -->
        <footer class="footer">
            2016 © AFW.
        </footer>
        <!-- Footer Ends -->


    </section>
    <!-- Main Content Ends -->
    
    <!-- MODAL -->
	<div id="dialog" class="modal-block mfp-hide">
	    <section class="panel panel-info panel-color">
	        <header class="panel-heading">
	            <h2 class="panel-title">Are you sure?</h2>
	        </header>
	        <div class="panel-body">
	            <div class="modal-wrapper">
	                <div class="modal-text">
	                    <p>Are you sure that you want to delete this row?</p>
	                </div>
	            </div>
	
	            <div class="row m-t-20">
	                <div class="col-md-12 text-right">
	                    <button id="dialogConfirm" class="btn btn-primary">Confirm</button>
	                    <button id="dialogCancel" class="btn btn-default">Cancel</button>
	                </div>
	            </div>
	        </div>
	    </section>
	</div>




<!-- js placed at the end of the document so the pages load faster -->
<script src="js/jquery.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/pace.min.js"></script>
<script src="js/modernizr.min.js"></script>
<script src="js/wow.min.js"></script>
<script src="js/jquery.scrollTo.min.js"></script>
<script src="js/jquery.nicescroll.js" type="text/javascript"></script>
<script src="js/jquery.app.js"></script>

<script src="assets/magnific-popup/magnific-popup.js"></script>
<script src="assets/jquery-datatables-editable/jquery.dataTables.js"></script> 
<script src="assets/datatables/dataTables.bootstrap.js"></script>
<script src="assets/jquery-datatables-editable/datatables.editable.init.js"></script>
<script src="assets/timepicker/bootstrap-datepicker.js"></script>
<!-- responsive-table--> 
<script src="assets/responsive-table/rwd-table.min.js" type="text/javascript"></script>

<script src="assets/sweet-alert/sweet-alert.min.js"></script>
<script src="assets/sweet-alert/sweet-alert.init.js"></script>

<script src="js/common.js"></script>
<script>
(function($){
	var companyId = 0;
	var contractId = 0;
	var month = 0;
	var type;
	var year;
	var dataArr;
	var root = location.protocol + '//' + location.host;
	
	$("#rentDate").datepicker({
       	format: 'yyyy-mm-dd',
       	autoclose: true
   	});
	
	window.clickInfoButton = function(e) {
		var id = e.target.id;
		var ids = id.split("_");
		companyId = ids[0];
		contractId = ids[1];
		month = ids[2];
		
		$('#rentPrice').val('');
 		$('#rentManager').val('');
 		$('#rentPower').val('');
 		$('#rentAdsl').val('');
 		$('#rentBusiness').val('');
 		$('#rentOther').val('');
 		$('#rentTotal').val('');
		
		for(var i =0; i<dataArr.length; i++) {
			var contractId2 = dataArr[i].contractId;
			if(contractId == contractId2) {
				var rentArr = dataArr[i].rentArr;
				for(var j =0; j<rentArr.length; j++) {
					var date = new Date(rentArr[j].rentDate);
		        	var day = ("0" + date.getDate()).slice(-2);
		        	var month2 = ("0" + (date.getMonth() + 1)).slice(-2);
		        	var dateFormat = date.getFullYear()+"-"+month2+"-"+day;
		        	
		        	var management = rentArr[j].rentManagement;
		        	var power = rentArr[j].rentPower;
		        	var adsl = rentArr[j].rentAdsl;
		        	var business = rentArr[j].rentBusiness;
		        	var other = rentArr[j].rentOther;
		        	
		        	if(rentArr[j].rentMonth == month) {
		         		$('#rentManager').val(management);
		         		$('#rentPower').val(power);
		         		$('#rentAdsl').val(adsl);
		         		$('#rentBusiness').val(business);
		         		$('#rentOther').val(other);
		         		$('#rentTotal').val(dataArr[i].rent + management + power + adsl + business + other);
		        	}
				}
			}
			
			$('#rentPrice').val(dataArr[i].rent);
			
		}
		
	    $('#myModal').modal('show');
	}
	
	$('#rentSave').on('click', function() {
		if(contractId == 0 || month == 0) {
			alert("請重新操作");
		} else {
			createOrUpdateRent(contractId, month);
		}
	})
	
	var createOrUpdateRent = function(contractId, month) {
		var companyId = "";
		var rent = {
			rentYear : $('#year').val(),
			rentMonth : month,
			rentManagement : $('#rentManager').val(),
			rentPower : $('#rentPower').val(),
			rentAdsl : $('#rentAdsl').val(),
			rentBusiness : $('#rentBusiness').val(),
			rentOther : $('#rentOther').val()
		}
		
		console.log(JSON.stringify(rent));
		$.ajax({
			url:root + "/AFW-I-System/rent/list/merge/" + contractId,
			type:'post',
			data : JSON.stringify(rent),
			dataType : 'json',
			contentType: 'application/json; charset=UTF-8',
			success : function(data) {
				console.log(data);
				if(data.status == 'success') {
					$('#rentClose').click();
					swal("修改成功!", "", "success");
					retriveDataByTypeAndYear(type, year);
					
				} else {
					alert(data.message);
				}
			},
			error : function(e) {
				alert("something error");
				console.log("ERROR: ", e);
			},
			done : function(e) {
				console.log("DONE");
			}
		});
	}
	
	var retriveDataByTypeAndYear = function(type, year) {
		$.ajax({
			url:root + "/AFW-I-System/retrive/rent/" + type +"/"+year,
			type:'get',
			dataType : 'json',
			contentType: 'application/json; charset=UTF-8',
			success : function(data) {
				console.log(jQuery.parseJSON(data.message));
				//console.log(data.message);
				if(data.status == 'success') {
					dataArr = jQuery.parseJSON(data.message);
					setData(dataArr);
					
				} else {
					alert(data.message);
				}
			},
			error : function(e) {
				alert("something error");
				console.log("ERROR: ", e);
			},
			done : function(e) {
				console.log("DONE");
			}
		});
	}
	
	var setData = function(dataArr) {
		var str = "";
		for(var i=0; i<dataArr.length; i++) {
			var companyId = dataArr[i].companyId;
			var contractId = dataArr[i].contractId;
			var name = dataArr[i].companyName;
			var rent = dataArr[i].rent;
			
			var order = dataArr[i].officeNum;
			
			var str1 =  "<tr>" +
       					"<td style=\"vertical-align:middle\">"+ order + "</td>" +
       					"<td><a class=\"company_link\" href=\"companyProfile.html?id="+ companyId +"\">" + name + "</a></td>";
			
			var rentStr = "";
			var rentArr = dataArr[i].rentArr;
			
			for(var k=1; k<13; k++) {
				var exist = false;
				for(var j = 0; j<rentArr.length; j++) {
					var date = new Date(rentArr[j].rentDate);
		        	var day = ("0" + date.getDate()).slice(-2);
		        	//var month = ("0" + (date.getMonth() + 1)).slice(-2);
		        	var month = rentArr[j].rentMonth;
		        	var dateFormat = date.getFullYear()+"-"+month+"-"+day;
		        	
		        	var shortAge = rentArr[j].rentShortage;
		        	var remark = rentArr[j].rentRemark;
		        	var rentReceipt = rentArr[j].rentReceipt;
		        	
		        	if(k == month) {
		        		exist = true;
			        	rentStr = rentStr + "<td style=\"vertical-align:middle\"><span onclick=\"clickInfoButton(event);\" class=\"label" + " label-danger"+ " popupButton\" id=" + companyId+"_"+contractId+"_"+month + ">Set</span></td>";
		        	}
				}
				if(!exist) {
					rentStr = rentStr + "<td style=\"vertical-align:middle\"><span onclick=\"clickInfoButton(event);\" class=\"label" + " label-success"+ " popupButton\" id=" + companyId+"_"+contractId+"_"+k + ">Save</span></td>";
				}
			}
			
			str = str + str1 + rentStr;
		}
		
		$('#rentTbody').html(str);
		
	}
	
	//TODO year auto check
	var checkYear = function() {
		
	}
	
	var checkSession = function() {
		$.ajax({
			url:root + "/AFW-I-System/session/user/check",
			type:'get',
			dataType : 'json',
			contentType: 'application/json',
			success : function(response) {
				//alert("success");
				if(response.status == 'success') {
					if(response.message == false) {
						alert("請重新登入");
						window.location.href = root + "/AFW-I-System/login.html";
						return false;
					} else {
						setUserInfoNavBar(response.userCode);
						hiddenInfo(response.userCode);
					}
				}
			},
			error : function(e) {
				alert("error");
				console.log("ERROR: ", e);
			},
			done : function(e) {
				console.log("DONE");
			}
		});
		
		return true;
	};
	
	$('#searchRent').on('click', function() {
		type = $('#contractType').val();
		year = $('#year').val();
		if(type != -1 && year != -1) {
			retriveDataByTypeAndYear(type, year);
		} else {
			alert('請選擇公司類型及年份');
		}
		
	});
	
	var setUserInfoNavBar = function(userCode) {
    	var name = '';
    	switch(userCode) {
	    	case 'AA': name = '管理員'; break;
	    	case '189': name = '南京店'; break;
	    	case '201': name = '復興店'; break;
	    	case '221': name = '微風店'; break;
	    	case '222': name = '大安店'; break;
	    	case '169': name = '敦化店'; break;
	    	case '295': name = '忠孝店'; break;
    	}
    	$('#userName').text(name);
    }
	
	var hiddenInfo = function(userCode) {
		if(userCode == 'AA') {
			$('#adminReconciliation').css('display', 'block');
		}
	};
	
	//page load
    window.onload = function() {
    	checkSession();
	};
})(jQuery);
</script>
</body>
</html>